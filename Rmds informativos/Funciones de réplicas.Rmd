---
title: "Funciones de réplicas"
output: html_document
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

# Determinación del Tamaño de Muestra sin Costo Variable por Tratamiento

## Teoría

Asumiendo que los costos por tratamiento ($c_i > 0$) son variables, bajo la restricción:

$$
\sum_{i=1}^t c_i r_i = C \quad \text{(Restricción presupuestaria)}
$$

y considerando que:

$$
Var(\text{MELI}(L)) = \sum_{i=1}^t \frac{\lambda_i^2 \sigma_i^2}{r_i} \quad \text{(Ecuación 5.25)}
$$

donde $L = \sum_{i=1}^t \lambda_i \mu_i$ y 

$$
\text{MELI}(L) = \sum_{i=1}^t \lambda_i \bar{y}_i \quad \text{(Ecuación 5.26)}
$$ 

## Minimización Lagrangiana

Para minimizar $Var(\text{MELI}(L))$ sujeto a la restricción presupuestaria, construimos el lagrangiano:

$$
Q = \sum_{i=1}^t \frac{\lambda_i^2 \sigma_i^2}{r_i} + \phi \left( \sum_{i=1}^t c_i r_i - C \right) \quad \text{(Ecuación 5.27)}
$$

Al resolver lo anterior, obtenemos:

$$
r_i = \frac{|\lambda_i| \sigma_i}{\sqrt{\phi c_i}} \quad \text{(Ecuación 5.28)}
$$

donde el multiplicador de Lagrange es:

$$
\phi = \frac{\left( \sum_{i=1}^t |\lambda_i| \sigma_i \sqrt{c_i} \right)^2}{C^2}
$$

**Recomendación:** Los coeficientes $\lambda_i$ deben expresarse como fracciones para simplificar el cálculo de $r_i$.

## Asignación Proporcional (Ecuación 5.29)

Si en lugar de optimizar con costos, asignamos las observaciones de forma proporcional a las desviaciones estándar (con $n$ fijo):

$$
\tilde{r}_{i} = \frac{n \sigma_i}{\sum_{s=1}^t \sigma_s}; \quad i = 1, \dots, t \quad \text{(Ecuación 5.29)}
$$

**Interpretación:** Los tratamientos con mayor variabilidad ($\sigma_i$) reciben más réplicas.

## Ejemplo

Supongamos que un agricultor tiene los siguientes datos referentes
a la producción en toneladas por hectárea de cuatro variedades de caña de
azúcar:

```{r}
# Crear el data frame con los datos
datos <- data.frame(
  V1 = c(78.82, 86.80, 68.65, 77.76, 75.80),
  V2 = c(56.60, 63.82, 58.71, 70.59, 81.74),
  V3 = c(105.126, 112.940, 108.118, 121.105, 115.870),
  V4 = c(96.89, 90.91, 92.97, 97.98, 95.93)
)

# Calcular media y desviación estándar con redondeo como en la imagen
media <- c(76.7, 67.40, 109.100, 92.80)
desviacion <- c(6.27, 9.57, 12.0, 3.32)

# Añadir nombres de fila
rownames(datos) <- c("1", "2", "3", "4", "5")

# Añadir filas de media y desviación
datos["Media", ] <- media
datos["Desviación", ] <- desviacion

# Mostrar la tabla
DT::datatable(datos)
```

Se observa que hay una proporcionalidad en las desviaciones estándar, entonces por (5.29) los tamaños de muestra adecuados para cada variedad
serían:

$$
\tilde{r}_1=\frac{(5*4)*(6.27)}{6.27+ 9.57+ 12+ 3.32}= 4.0243\approx4
$$

$$
\tilde{r}_2=\frac{(5*4)*(9.57)}{6.27+ 9.57+ 12+ 3.32}= 6.1424\approx6
$$

$$
\tilde{r}_3=\frac{(5*4)*(12)}{6.27+ 9.57+ 12+ 3.32}= 7.7021\approx8
$$

$$
\tilde{r}_4=\frac{(5*4)*(3.32)}{6.27+ 9.57+ 12+ 3.32}= 2.1309\approx2
$$


Las réplicas asignadas por cada uno de los tratamientos son $4,6,8,2$ respectivamente. 

# Determinación del Tamaño de Muestra con Costo Variable por Tratamiento

## Teoría

Asumiendo que los costos por tratamiento ($c_i > 0$) son variables, bajo la restricción:

$$
\sum_{i=1}^t c_i r_i = C \quad \text{(Restricción presupuestaria)}
$$

y considerando que:

$$
Var(\text{MELI}(L)) = \sum_{i=1}^t \frac{\lambda_i^2 \sigma_i^2}{r_i} \quad \text{(Ecuación 5.25)}
$$

donde $L = \sum_{i=1}^t \lambda_i \mu_i$ y 

$$
\text{MELI}(L) = \sum_{i=1}^t \lambda_i \bar{y}_i \quad \text{(Ecuación 5.26)}
$$ 

## Minimización Lagrangiana

Para minimizar $Var(\text{MELI}(L))$ sujeto a la restricción presupuestaria, construimos el lagrangiano:

$$
Q = \sum_{i=1}^t \frac{\lambda_i^2 \sigma_i^2}{r_i} + \phi \left( \sum_{i=1}^t c_i r_i - C \right) \quad \text{(Ecuación 5.27)}
$$

Al resolver lo anterior, obtenemos:

$$
r_i = \frac{|\lambda_i| \sigma_i}{\sqrt{\phi c_i}} \quad \text{(Ecuación 5.28)}
$$

donde el multiplicador de Lagrange es:

$$
\phi = \frac{\left( \sum_{i=1}^t |\lambda_i| \sigma_i \sqrt{c_i} \right)^2}{C^2}
$$

**Recomendación:** Los coeficientes $\lambda_i$ deben expresarse como fracciones para simplificar el cálculo de $r_i$.

## Ejemplo

Supongamos que un agricultor tiene los siguientes datos referentes
a la producción en toneladas por hectárea de cuatro variedades de caña de
azúcar y sus respectivos costos:

```{r}
library(DT)

# Datos principales
datos <- data.frame(
  V1 = c(78.82, 86.80, 68.65, 77.76, 75.80),
  V2 = c(56.60, 63.82, 58.71, 70.59, 81.74),
  V3 = c(105.126, 112.940, 108.118, 121.105, 115.870),
  V4 = c(96.89, 90.91, 92.97, 97.98, 95.93)
)

# Agregar filas
media <- c(76.7, 67.40, 109.100, 92.80)
desviacion <- c(6.27, 9.57, 12.0, 3.32)
costos <- c(1000, 200, 700, 1100)

rownames(datos) <- c("1", "2", "3", "4", "5")
datos["Media", ] <- media
datos["Desviación", ] <- desviacion
datos["Costos", ] <- costos

# Crear tabla del presupuesto como otro data.frame
presupuesto <- data.frame(
  Concepto = "Presupuesto total del experimento",
  Valor_COP = format(50000, big.mark = ".", decimal.mark = ",")
)

# Mostrar ambas tablas en pestañas
htmltools::tagList(
  DT::datatable(datos, caption = htmltools::tags$strong("Tabla de datos del experimento")),
  DT::datatable(presupuesto, caption = htmltools::tags$strong("Presupuesto"))
)
```

Se observa que hay tenemos un costo por cada tratamiento y un presupuesto total, entonces por (5.28) los tamaños de muestra adecuados para cada variedad serían:

Iniciando por el calculo de $\Phi$

$$
\Phi= \sqrt{\frac{\left(\left(\frac{1}{4}*6.27*\sqrt{1000}\right)+\left(\frac{1}{4}*9.57*\sqrt{200}\right)+\left(\frac{1}{4}*12*\sqrt{700}\right)+\left(\frac{1}{4}*3.32*\sqrt{1100}\right)\right)^2}{50000^2}}=1.448629\times10^{-05}
$$

$$
r_1=\frac{\frac{1}{4}*6.27}{\sqrt{1.448629\times10^{-05}*1000}}=13.0235\approx13
$$

$$
r_2=\frac{\frac{1}{4}*9.57}{\sqrt{1.448629\times10^{-05}*200}}=44.4486\approx44
$$
$$
r_3=\frac{\frac{1}{4}*12}{\sqrt{1.448629\times10^{-05}*700}}=29.7915\approx30
$$

$$
r_4=\frac{\frac{1}{4}*3.32}{\sqrt{1.448629\times10^{-05}*1100}}=6.5751\approx7
$$
Las réplicas asignadas por cada uno de los tratamientos son $13,44,30,7$ respectivamente. 

# Asignación de tratamientos y réplicas con Función de Costos y Varianza Máxima


## Teoría

En el modelo de componentes de varianza tanto el número de tratamientos $t$ como el número de réplicas $r$ son variables y sus estimaciones están ligadas con el control de dichas varianzas. Un criterio usual para elegir los valores de $r$ y $t$ es el de minimizar los costos en la estimación de la media $\mu$. Una medida de la cantidad de información disponible para estimar $\mu$ es la varianza de la media muestral dada por:

$$
v(\bar{y}..) = \frac{\sigma^2}{rt} + \frac{\sigma_A^2}{t}
$$

En el caso de un diseño C.A. (Completamente Aleatorizado).

El problema se reduce a encontrar los valores de $r$ y $t$ que minimicen la función de costos dada por:

$$
C = C_1 t + C_2 t r
$$

para una varianza $v(\bar{y}..)$ fija, donde $C_1$ es el costo por unidad de tratamiento y $C_2$ es el costo por unidad experimental. La solución matemática es, según Mendenhall (1968):

$$
t = \frac{1}{v(\bar{y}..)} \left( \hat{\sigma}_A^2 + \sqrt{\frac{\hat{\sigma}_A^2\hat\sigma^2C^2}{C^1}}  \right)
$$

y

$$
r = \sqrt{\frac{\hat\sigma^2 C_1}{\hat{\sigma}_A^2 C_2}}
$$

## Ejemplo

Un estudio genético en ganado, consistió en seleccionar aleatoriamente varios machos (toros) apareados con grupos separados de hembras. Cuando nacieron los terneros, se midieron los pesos iniciales como
medida en un estudio de pesos hereditarios (estudios de progene). En la tabla a continuación se presentan los pesos al nacer de los terneros de cada uno de cinco grupos de apareamiento. 

```{r}
# Crear el data frame
datos <- data.frame(
  `Macho_número_85` = c(61, 71, 56, 75, 99, 80, 75, 62),
  `Macho_número_113` = c(75, 102, 95, 103, 98, 115, NA, NA),
  `Macho_número_134` = c(58, 60, 59, 65, 54, 57, NA, NA),
  `Macho_número_158` = c(57, 121, 56, 58, 101, 110, 67, NA),
  `Macho_número_165` = c(59, 46, 120, 115, 93, 105, 75, 115)
)

# Mostrar la tabla
DT::datatable(datos)
```

Obteniendo la tabla ANOVA

```{r}
# Crear los datos en formato largo
replicacion <- rep(1:8, times = 5)
toro <- rep(c(85, 113, 134, 158, 165), each = 8)
respuesta <- c(
  61, 71, 56, 75, 99, 80, 75, 62,  # Toro 85
  75, 102, 95, 103, 98, 115, NA, NA,  # Toro 113
  58, 60, 59, 65, 54, 57, NA, NA,  # Toro 134
  57, 121, 56, 58, 101, 110, 67, NA,  # Toro 158
  59, 46, 120, 115, 93, 105, 75, 115  # Toro 165
)

# Crear el data frame
datos <- data.frame(
  Toro = as.factor(toro),
  Respuesta = respuesta
)

# Eliminar filas con NA
datos <- na.omit(datos)

# ANOVA
modelo <- aov(Respuesta ~ Toro, data = datos)
summary(modelo)
```

De la anterior tabal pondemos obtener los valores de $\hat\sigma_e^2$ y de $\hat\sigma_A^2$

$$
\hat\sigma_e^2=\text{CME}=416.2
$$
$$
\hat\sigma_A^2=\frac{\text{CMA}-\text{CME}}{r_0}=\frac{(1517.6-416.2)}{6.97}=158.02
$$

Donde,

$$
r_0=\frac{\left(35-\frac{\left(8^2+6^2+6^2+7^2+8^2\right)}{35}\right)}{4}=6.97
$$
Suponiendo una varianza máxima $V(\bar{y}_{..})=43.49$, $C1 = 150000$ y $C2 = 50000$, se encuentra que:

$$
t = \frac{1}{43.49} \left( 158.015 + \sqrt{\frac{(158.015)(416.21409)(50000)}{150000}}  \right)=7.04
$$

y

$$
r = \sqrt{\frac{(416.21409) (150000)}{(158.015) (50000)}}=3.35
$$

Para una varianza de la media muestral no mayor de 43,49, deberían seleccionarse 7 toros y 3 terneros por cada toro, asumiendo que el costo experimental de cada toro es de $150000$ y el de cada ternero es de $50000$.


# Referencia

**Referencia Bibliográfica**

> Melo M., O. O., López P., L. A., & Melo M., S. E. (2007). *Diseño de Experimentos: Métodos y Aplicaciones* (1a ed.). Pro-Oﬀset Editorial S.A.. Capítulo 5, Sección 5.7.5, pp. 204-205.



